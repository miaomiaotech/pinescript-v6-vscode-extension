# Pine Script 词法器测试文档

## 概述

本目录包含 Pine Script v6 词法分析器的全面测试套件。测试基于实际的 Pine Script 代码示例（来自 `samples/` 目录）进行设计，确保词法器能够正确处理真实世界的代码。

## 测试文件

### lexer.test.js

完整的词法器单元测试，包含 **64 个测试用例**，分为 10 个测试套件。

### parser.test.js

完整的 AST 解析器单元测试，包含 **42 个测试用例**，分为 9 个测试套件。验证解析器生成的 AST 结构符合预期。

## 词法器测试覆盖

### 1. 基础字面量 (10 个测试)

- ✅ 整数 (`123`)
- ✅ 浮点数 (`123.456`)
- ✅ 科学计数法 (`1.5e10`, `2.5e-5`)
- ✅ 布尔值 (`true`, `false`)
- ✅ 字符串
  - 双引号字符串 (`"Hello World"`)
  - 单引号字符串 (`'Hello World'`)
  - 转义字符 (`"Line 1\nLine 2"`)
  - **中文字符串** (`"KDJ指标"`)
- ✅ 十六进制颜色
  - 6 位颜色 (`#FF5733`)
  - 8 位带透明度颜色 (`#FF5733AA`)

### 2. 标识符和关键字 (6 个测试)

- ✅ 普通标识符 (`myVar`)
- ✅ 带下划线的标识符 (`my_var_name`)
- ✅ **下划线开头的标识符** (`_inRange`) - 常用于私有函数
- ✅ 控制流关键字 (`if`, `else`, `for`, `while`, `var`, `varip`, `const`)
- ✅ 类型关键字 (`int`, `float`, `bool`, `string`, `color`)
- ✅ 逻辑运算符关键字 (`and`, `or`, `not`)
- ✅ 特殊关键字 (`na`)

### 3. 运算符 (5 个测试)

- ✅ 算术运算符 (`+`, `-`, `*`, `/`, `%`)
- ✅ 比较运算符 (`==`, `!=`, `<`, `>`, `<=`, `>=`)
- ✅ 赋值运算符 (`=`, `:=`)
- ✅ 箭头运算符 (`=>`)
- ✅ 三元运算符 (`?`, `:`)

### 4. 分隔符 (2 个测试)

- ✅ 括号 (`(`, `)`, `[`, `]`)
- ✅ 逗号和点号 (`,`, `.`)

### 5. 注释 (4 个测试)

- ✅ 单行注释 (`// comment`)
- ✅ 块注释 (`/* multi-line */`)
- ✅ 版本注解 (`//@version=6`)
- ✅ 代码中混合注释
- ✅ **中文注释** (`// 这是一个中文注释`)

### 6. 复杂表达式 (7 个测试)

- ✅ 变量声明 (`var x = 10`)
- ✅ 函数调用 (`plot(close, color=color.red)`)
- ✅ 数组访问 (`arr[0]`, `value[1]`)
- ✅ 成员访问 (`ta.sma(close, 20)`)
- ✅ 三元表达式 (`x > 0 ? 1 : -1`)
- ✅ if 语句
- ✅ for 循环

### 7. 函数定义 (3 个测试)

- ✅ 简单函数 (`myFunc(x) => x * 2`)
- ✅ 带类型参数的函数 (`myFunc(float x, int y) => x + y`)
- ✅ 导出函数 (`export myFunc(x) => x`)

### 8. 位置信息 (2 个测试)

- ✅ 行号和列号跟踪
- ✅ Token 长度验证

### 9. 边界情况 (6 个测试)

- ✅ 空源代码
- ✅ 只有空白字符
- ✅ 只有注释
- ✅ 未闭合的字符串
- ✅ 无效的十六进制颜色
- ✅ 连续运算符

### 10. 实际 Pine Script 代码片段 (19 个测试)

基于 `samples/` 目录中的真实代码示例：

- ✅ `indicator` 声明
- ✅ 完整的变量声明和更新 (`var float`, `sum := sum + close`)
- ✅ `plot` 语句
- ✅ `if-else` 条件语句
- ✅ **解构赋值** (`[macd_line, signal_line, histogram] = ta.macd(...)`)
- ✅ **负数偏移参数** (`offset=-5`)
- ✅ **复杂的条件表达式** (`ta.crossover(k, d) and k < 30`)
- ✅ **嵌套函数调用** (`ta.highest(ta.rsi(close, 14), 10)`)
- ✅ **hline 样式** (`hline.style_dotted`)
- ✅ **color.new 函数** (`color.new(color.red, 90)`)
- ✅ **三元运算符与颜色** (`macd >= 0 ? color.green : color.red`)
- ✅ **input 函数带多个命名参数** (`input.int(14, title="...", minval=1)`)
- ✅ **plotshape 完整语句** (`style=shape.triangleup, location=location.bottom`)
- ✅ **varip 声明** (`varip int counter = 0`)
- ✅ **逻辑运算符组合** (`cond1 and cond2 or not cond3`)

## 解析器测试覆盖

### 1. 变量声明 (6 个测试)
- ✅ 简单变量声明 (`x = 10`)
- ✅ `var` 关键字声明
- ✅ 带类型注解的变量声明 (`var float x = 10.5`)
- ✅ `varip` 声明
- ✅ `const` 声明
- ✅ 字符串初始化

### 2. 表达式 (8 个测试)
- ✅ 二元表达式（加法、比较）
- ✅ 一元表达式（负号、not）
- ✅ 三元表达式
- ✅ 运算符优先级
- ✅ 逻辑表达式（and、or）

### 3. 函数调用 (4 个测试)
- ✅ 简单函数调用
- ✅ 带多个参数的函数调用
- ✅ 命名参数函数调用
- ✅ 嵌套函数调用

### 4. 成员访问 (4 个测试)
- ✅ 简单成员访问 (`color.red`)
- ✅ 链式成员访问 (`ta.sma()`)
- ✅ 数组索引访问 (`arr[0]`)
- ✅ 变量历史访问 (`close[1]`)

### 5. 控制流 (4 个测试)
- ✅ if 语句
- ✅ if-else 语句
- ✅ for 循环
- ✅ while 循环

### 6. 函数定义 (4 个测试)
- ✅ 简单函数定义
- ✅ 带类型参数的函数
- ✅ 导出函数 (`export`)
- ✅ 多行函数体

### 7. 数组和字面量 (4 个测试)
- ✅ 数组字面量 (`[1, 2, 3]`)
- ✅ 布尔字面量 (`true`, `false`)
- ✅ na 字面量
- ✅ 颜色字面量 (`#FF5733`)

### 8. 复杂示例 (4 个测试)
- ✅ 完整的 indicator 声明
- ✅ 带条件的 plot 语句
- ✅ 解构赋值形式
- ✅ 多语句程序

### 9. 边界情况 (4 个测试)
- ✅ 空程序
- ✅ 只有注释
- ✅ 只有版本注解
- ✅ 空白行处理

## 运行测试

### 运行所有测试
```bash
npm test
```

### 只运行词法器测试
```bash
npm run test:lexer
```

### 只运行解析器测试
```bash
npm run test:parser
```

### 测试 samples 目录中的实际文件
```bash
npm run test:samples
```

## 测试统计

### 词法器测试
- **测试数**: 64
- **测试套件**: 10
- **通过率**: 100%
- **执行时间**: ~50ms

### 解析器测试
- **测试数**: 42
- **测试套件**: 9
- **通过率**: 100%
- **执行时间**: ~45ms

### 总计
- **总测试数**: 106
- **总测试套件**: 19
- **总通过率**: 100%

## 测试方法论

### 1. 单元测试方法
- 每个测试专注于单一功能点
- 使用最小化的测试用例
- 清晰的断言和错误消息

### 2. 辅助函数
- `getTokens(source)`: 获取简化的 token 列表（忽略空白和换行）
- `getFullTokens(source)`: 获取完整的 token 列表（包含换行但不包含空白）

### 3. 测试覆盖策略
- **基础覆盖**: 所有 token 类型
- **边界情况**: 空输入、错误输入、极端情况
- **真实场景**: 基于 samples 目录的实际代码
- **国际化**: 中文字符支持

## 已知限制

目前词法器测试不覆盖：
- 性能/基准测试（可能需要单独的基准测试套件）
- 错误恢复机制
- 超大文件处理

## 未来改进

1. **性能测试**: 添加大文件词法分析的性能基准
2. **错误处理**: 测试更多的错误恢复场景
3. **模糊测试**: 使用随机生成的 Pine Script 代码进行模糊测试
4. **集成测试**: 与解析器的集成测试

## 贡献指南

添加新测试时，请遵循以下原则：

1. **命名清晰**: 测试名称应清楚描述被测试的功能
2. **单一职责**: 每个测试只测试一个特性
3. **独立性**: 测试之间不应相互依赖
4. **可维护性**: 使用辅助函数避免重复代码
5. **注释说明**: 复杂的测试用例添加注释解释

## 相关文件

- `src/parser/lexer.ts` - 词法器实现
- `test/lexer.test.js` - 词法器测试
- `test-samples-lexer.js` - Samples 目录测试脚本
- `samples/*.pine` - 真实的 Pine Script 代码示例
